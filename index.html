<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–°–≤–µ–∂–∏–µ –≤–∏–¥–µ–æ YouTube ‚Äî —Ä–∞–±–æ—á–∏–π —Å–ø–∏—Å–æ–∫</title>
  <style>
    :root{--bg:#0b0c10;--card:#14161c;--border:#232730;--txt:#eaf0f1;--muted:#9aa4b2;--link:#8ab4f8}
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;margin:24px;background:var(--bg);color:var(--txt)}
    h1{margin:0 0 12px;font-size:24px}
    .meta{opacity:.8;margin-bottom:10px}
    .controls{margin:8px 0 16px; display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    input[type=number]{width:120px;padding:6px;border-radius:8px;border:1px solid #303642;background:#0f1117;color:var(--txt)}
    select{padding:6px;border-radius:8px;border:1px solid #303642;background:#0f1117;color:var(--txt)}
    .pill{padding:4px 8px;border:1px solid #2e3540;border-radius:999px}
    .card{display:flex; gap:12px; align-items:flex-start; background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px 14px;margin:10px 0;box-shadow:0 1px 4px rgba(0,0,0,.3)}
    .left{display:flex; align-items:center; gap:10px; min-width: 28px;}
    .ch{font-weight:600}
    .title{margin:2px 0}
    a{color:var(--link);text-decoration:none}
    a:hover{text-decoration:underline}
    .age{opacity:.8;font-size:13px}
    .dim{opacity:.5}
  </style>
</head>
<body>
  <h1>–°–≤–µ–∂–∏–µ –≤–∏–¥–µ–æ YouTube ‚Äî —Ä–∞–±–æ—á–∏–π —Å–ø–∏—Å–æ–∫</h1>
  <div class="meta">–ü—Ä–∏ –æ—Ç–º–µ—Ç–∫–µ –≤–∏–¥–µ–æ ‚Äî —Å—Å—ã–ª–∫–∞ –ø–æ–ø–∞–¥—ë—Ç <b>–≤ –ª–∏—á–Ω—É—é —Ç–∞–±–ª–∏—Ü—É</b> –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è (—Å—Ç—Ä–æ–≥–æ –æ–¥–Ω–∞ —è—á–µ–π–∫–∞).</div>

  <div class="controls">
    <label>–Ø ‚Äî 
      <select id="assignee">
        <option>–†–∞—Ñ</option>
        <option>–ü–µ—Ç—è</option>
      </select>
    </label>
    <button id="soundBtn" class="pill">üîî –í–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫</button>
    <label>–ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ, —Å–µ–∫: <input type="number" id="period" value="10" min="5" max="120"></label>
    <label class="pill" style="padding:6px 10px;"><input type="checkbox" id="hideDone" /> —Å–∫—Ä—ã–≤–∞—Ç—å –ø–æ–º–µ—á–µ–Ω–Ω—ã–µ</label>
    <span id="status" class="age"></span>
  </div>

  <div id="list"></div>

<script>
const API_BASE = 'https://ytfresh.ytcomm.ru/api';
const CHECKED_URL = API_BASE + '/checked';
const TOGGLE_URL  = API_BASE + '/toggle';

let timer = null;
const list = document.getElementById('list');
const statusEl = document.getElementById('status');
const soundBtn = document.getElementById('soundBtn');
const periodInp = document.getElementById('period');
const hideDone = document.getElementById('hideDone');
const assigneeSel = document.getElementById('assignee');

// --- –∑–≤—É–∫
let audioCtx = null;
function enableSound(){ try{ audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }catch(e){} }
function beep(){ if(!audioCtx) return; const o=audioCtx.createOscillator(), g=audioCtx.createGain(); o.connect(g); g.connect(audioCtx.destination); o.type='sine'; o.frequency.value=880; g.gain.setValueAtTime(0.001,audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.2,audioCtx.currentTime+0.02); g.gain.exponentialRampToValueAtTime(0.0001,audioCtx.currentTime+0.25); o.start(); o.stop(audioCtx.currentTime+0.26); }
soundBtn.addEventListener('click', () => { enableSound(); soundBtn.textContent='üîî –ó–≤—É–∫ –≤–∫–ª—é—á—ë–Ω'; soundBtn.disabled=true; beep(); });

// --- —É—Ç–∏–ª–∏—Ç—ã
function formatAge(sec){ sec=Math.max(0,sec|0); if(sec<60)return sec+' —Å–µ–∫ –Ω–∞–∑–∞–¥'; const m=sec/60|0; if(m<60)return m+' –º–∏–Ω –Ω–∞–∑–∞–¥'; const h=m/60|0, mm=m%60; if(h<24)return h+' —á'+(mm?' '+mm+' –º–∏–Ω':'')+' –Ω–∞–∑–∞–¥'; const d=h/24|0, hh=h%24; if(d<7)return d+' –¥'+(hh?' '+hh+' —á':'')+' –Ω–∞–∑–∞–¥'; const w=d/7|0, dd=d%7; return w+' –Ω–µ–¥'+(dd?' '+dd+' –¥':'')+' –Ω–∞–∑–∞–¥'; }
function ensureAgeSeconds(it){ if(typeof it.age_seconds==='number') return it.age_seconds; if(it.published_at_utc){ const t=Date.parse(it.published_at_utc); if(!Number.isNaN(t)) return Math.max(0, ((Date.now()-t)/1000)|0); } return 9e15; }
function uniqKey(it){ return it.url || (it.channel + '|' + it.title); }
function videoIdFromUrl(url){ try{ const u=new URL(url); if(u.hostname==='youtu.be')return u.pathname.replace('/','').slice(0,11); if(u.pathname==='/watch')return (new URLSearchParams(u.search).get('v')||'').slice(0,11); }catch(e){} const m=(url||'').match(/[0-9A-Za-z_-]{11}/); return m?m[0]:''; }
async function fetchJson(url){ const res = await fetch(url+(url.includes('?')?'&':'?')+'ts='+Date.now(), {cache:'no-store'}); if(!res.ok) throw new Error(res.status+' '+res.statusText); return await res.json(); }
async function apiGetChecked(){ const res = await fetch(CHECKED_URL); if(!res.ok) throw new Error('GET '+res.status); return await res.json(); }
async function apiToggle(payload){ const res = await fetch(TOGGLE_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)}); if(!res.ok) throw new Error('POST '+res.status); return await res.json(); }

async function load(){
  try{
    const [data, checkedJson] = await Promise.allSettled([ fetchJson('latest_results.json'), apiGetChecked() ]);
    if(data.status!=='fulfilled') throw data.reason;
    if(checkedJson.status!=='fulfilled') throw checkedJson.reason;
    const items = (data.value.items || []).slice();
    const checked = new Set(checkedJson.value.checked || []);

    items.sort((a,b) => ensureAgeSeconds(a) - ensureAgeSeconds(b));

    const prevStr = localStorage.getItem('seen_urls') || '[]';
    const prev = new Set(JSON.parse(prevStr));
    let hasNew = false;
    const nowSet = [];

    list.innerHTML = '';
    items.forEach((it) => {
      const vid = videoIdFromUrl(it.url||'');
      const key = uniqKey(it);
      nowSet.push(key);
      if(!prev.has(key)) hasNew = true;
      const ageSec = ensureAgeSeconds(it);
      const isChecked = vid && checked.has(vid);
      if (hideDone.checked && isChecked) return;

      const wrap = document.createElement('div'); wrap.className = 'card' + (isChecked?' dim':'');
      const left = document.createElement('div'); left.className='left';
      const cb = document.createElement('input'); cb.type='checkbox'; cb.checked=isChecked; cb.title=isChecked?'–ü–æ–º–µ—á–µ–Ω–æ':'–ù–µ –ø–æ–º–µ—á–µ–Ω–æ';
      left.appendChild(cb); wrap.appendChild(left);

      const right = document.createElement('div'); right.style.flex='1 1 auto';
      const ch = document.createElement('div'); ch.className='ch'; ch.textContent='['+(it.channel||'')+']'; right.appendChild(ch);
      const p = document.createElement('div'); p.className='title'; const a=document.createElement('a'); a.href=it.url; a.textContent=it.title; a.target='_blank'; a.rel='noopener'; p.appendChild(a); right.appendChild(p);
      const meta = document.createElement('div'); meta.className='age'; meta.textContent = formatAge(ageSec); right.appendChild(meta);

      cb.addEventListener('change', async () => {
        try{
          const payload = { 
            video_id: vid, 
            checked: cb.checked,
            url: it.url,
            assignee: assigneeSel.value || ''
          };
          await apiToggle(payload);
          wrap.className = 'card' + (cb.checked?' dim':'');
        }catch(e){
          cb.checked = !cb.checked; // –æ—Ç–∫–∞—Ç
          alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø–∏—Å–∞—Ç—å: ' + e.message);
        }
      });

      wrap.appendChild(right); list.appendChild(wrap);
    });
    localStorage.setItem('seen_urls', JSON.stringify(nowSet.slice(0,1000)));
    const gen = data.value.generated_at_utc ? new Date(data.value.generated_at_utc) : new Date();
    statusEl.textContent = '–û–±–Ω–æ–≤–ª–µ–Ω–æ: ' + gen.toLocaleString() + ' ‚Ä¢ —ç–ª–µ–º–µ–Ω—Ç–æ–≤: ' + items.length;
    if(hasNew){ enableSound(); beep(); }
  }catch(e){
    statusEl.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + e.message;
  }
}

function startTimer(){ const seconds=Math.max(5, Math.min(120, parseInt((periodInp.value||'10'),10))); if(timer) clearInterval(timer); timer = setInterval(load, seconds*1000); }
periodInp.addEventListener('change', startTimer);
hideDone.addEventListener('change', load);
startTimer(); load();
</script>
</body>
</html>
