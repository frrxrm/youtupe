<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>YT Fresh ‚Äî –ø–æ—Å–ª–µ–¥–Ω–∏–µ –≤–∏–¥–µ–æ</title>
  <style>
    :root {
      --bg: #0f1115;
      --card: #181b22;
      --muted: #8f9bb3;
      --text: #e6e9ef;
      --accent: #5eead4;
      --ok: #22c55e;
      --warn: #f59e0b;
      --err: #ef4444;
      --link: #93c5fd;
    }
    html,body {margin:0;height:100%;background:var(--bg);color:var(--text);font:14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji";}
    a{color:var(--link);text-decoration:none}
    a:hover{text-decoration:underline}
    .wrap{max-width:1100px;margin:0 auto;padding:20px}
    header{display:flex;gap:14px;flex-wrap:wrap;align-items:center;justify-content:space-between;margin-bottom:16px}
    .title{font-weight:700;font-size:18px;display:flex;gap:10px;align-items:center}
    .pill{background:#11151c;border:1px solid #242a35;border-radius:999px;padding:6px 10px;display:flex;gap:8px;align-items:center}
    select,button,input[type="checkbox"]{accent-color:var(--accent)}
    select{background:#0f141a;border:1px solid #2a3240;color:var(--text);border-radius:8px;padding:6px 10px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px}
    .card{background:var(--card);border:1px solid #202633;border-radius:14px;padding:12px;display:flex;flex-direction:column;gap:8px}
    .top{display:flex;justify-content:space-between;gap:10px}
    .ch{color:var(--muted);font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:65%}
    .age{font-size:12px;color:#cbd5e1}
    .titleln{font-weight:600;display:block}
    .controls{display:flex;align-items:center;justify-content:space-between;margin-top:6px;gap:8px}
    .checkline{display:flex;align-items:center;gap:8px;font-size:13px}
    .status{font-size:12px}
    .status.ok{color:var(--ok)} .status.err{color:var(--err)} .status.warn{color:var(--warn)}
    .footer{opacity:.7;font-size:12px;margin-top:10px}
    .muted{color:var(--muted)}
    .hidden{display:none}
    .kbd{font:12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;background:#0d1320;border:1px solid #263147;border-radius:6px;padding:2px 6px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">
        <span>üü¢ YT Fresh</span>
        <span class="muted" id="updatedAt"></span>
      </div>
      <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
        <label class="pill">
          –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å:
          <select id="assignee">
            <option>–ü–µ—Ç—è</option>
            <option>–†–∞—Ñ</option>
          </select>
        </label>
        <label class="pill" title="–ó–≤—É–∫ –≤–∫–ª—é—á–µ–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é. –ü—Ä–∏ –ø–µ—Ä–≤–æ–º –∫–ª–∏–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Ä–∞–∑–±–ª–æ–∫–∏—Ä—É–µ—Ç –∞—É–¥–∏–æ.">
          <input id="sound-toggle" type="checkbox" checked>
          –í–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫
        </label>
      </div>
    </header>

    <div id="alert" class="hidden"></div>

    <div id="grid" class="grid"></div>

    <div class="footer muted">
      –°–ø–∏—Å–æ–∫ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏. –ß–µ–∫–±–æ–∫—Å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –≤–∏–¥–µ–æ –≤ –ª–∏—á–Ω—É—é —Ç–∞–±–ª–∏—Ü—É –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è.
    </div>
  </div>

  <!-- –∫–æ—Ä–æ—Ç–∫–∏–π –∑–≤—É–∫ (beep) –≤—Å—Ç—Ä–æ–µ–Ω –∫–∞–∫ data URI) -->
  <audio id="ding" preload="auto"
    src="data:audio/mp3;base64,//uQZAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAACAAACcQAAABh3AQACAAACAAACAAAAGF7/0Zf...">
  </audio>

  <script>
  // ================== –ù–ê–°–¢–†–û–ô–ö–ò ==================
  const API_BASE = (new URLSearchParams(location.search).get('api')) || 'https://ytfresh.ytcomm.ru/api';
  const RESULTS_URL = 'latest_results.json'; // –¥–æ–ª–∂–µ–Ω –ª–µ–∂–∞—Ç—å —Ä—è–¥–æ–º –Ω–∞ GitHub Pages
  const REFRESH_MS = 10 * 60 * 1000; // –∞–≤—Ç–æ-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–∞–∑ –≤ 10 –º–∏–Ω—É—Ç
  const SOUND_KEY = 'ytfresh_sound';
  const ASSIGNEE_KEY = 'ytfresh_assignee';
  const LAST_SEEN_KEY = 'ytfresh_last_seen_ids';

  // ================== –ü–ï–†–ï–ú–ï–ù–ù–´–ï ==================
  let soundEnabled = JSON.parse(localStorage.getItem(SOUND_KEY) ?? 'true'); // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –í–ö–õ
  let audioUnlocked = false;
  const ding = document.getElementById('ding');
  const grid = document.getElementById('grid');
  const updatedAtEl = document.getElementById('updatedAt');
  const soundToggle = document.getElementById('sound-toggle');
  const assigneeSel = document.getElementById('assignee');
  const alertBox = document.getElementById('alert');

  // –ø—Ä–∏–º–µ–Ω—è–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
  soundToggle.checked = !!soundEnabled;
  assigneeSel.value = localStorage.getItem(ASSIGNEE_KEY) || assigneeSel.value;

  soundToggle.addEventListener('change', () => {
    soundEnabled = soundToggle.checked;
    localStorage.setItem(SOUND_KEY, JSON.stringify(soundEnabled));
  });
  assigneeSel.addEventListener('change', () => {
    localStorage.setItem(ASSIGNEE_KEY, assigneeSel.value);
  });

  // –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∑–≤—É–∫–∞ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–∏ (—Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ –±—Ä–∞—É–∑–µ—Ä–æ–≤)
  function unlockAudioOnce() {
    if (audioUnlocked) return;
    ding.muted = true;
    ding.play().then(() => {
      ding.pause();
      ding.currentTime = 0;
      ding.muted = false;
      audioUnlocked = true;
      window.removeEventListener('pointerdown', unlockAudioOnce);
      window.removeEventListener('keydown', unlockAudioOnce);
    }).catch(() => {/* –ø–æ–ø—Ä–æ–±—É–µ–º –Ω–∞ —Å–ª–µ–¥—É—é—â–µ–º –∂–µ—Å—Ç–µ */});
  }
  window.addEventListener('pointerdown', unlockAudioOnce);
  window.addEventListener('keydown', unlockAudioOnce);

  function playBeep() {
    if (!soundEnabled || !audioUnlocked) return;
    try { ding.currentTime = 0; ding.play().catch(()=>{}); } catch {}
  }

  // ================== –£–¢–ò–õ–ò–¢–´ ==================
  const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));

  async function fetchJson(url, noCache=false) {
    const opts = noCache ? {cache:'no-store'} : {};
    const r = await fetch(url, opts);
    if (!r.ok) throw new Error('HTTP '+r.status);
    return r.json();
  }
  async function apiGetChecked() {
    const r = await fetch(API_BASE + '/checked', {cache:'no-store'});
    if (!r.ok) throw new Error('API checked ' + r.status);
    return r.json();
  }
  async function apiToggle(vid, checked, url, assignee) {
    const r = await fetch(API_BASE + '/toggle', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({video_id: vid, checked, url, assignee})
    });
    if (!r.ok) throw new Error('API toggle ' + r.status);
    return r.json();
  }
  function vidFromUrl(url) {
    const m = String(url||'').match(/(?:v=|youtu\.be\/)([0-9A-Za-z_-]{11})/);
    return m ? m[1] : '';
  }
  function timeAgo(iso) {
    const t = new Date(iso);
    if (isNaN(t)) return '';
    const s = Math.floor((Date.now() - t.getTime())/1000);
    const abs = Math.max(0, s);
    const m = Math.floor(abs/60);
    const h = Math.floor(m/60);
    const d = Math.floor(h/24);
    if (abs < 60) return `${abs} —Å–µ–∫ –Ω–∞–∑–∞–¥`;
    if (m < 60) return `${m} –º–∏–Ω –Ω–∞–∑–∞–¥`;
    if (h < 24) return `${h} —á –Ω–∞–∑–∞–¥`;
    return `${d} –¥–Ω –Ω–∞–∑–∞–¥`;
  }

  function showAlert(text, kind='err') {
    alertBox.className = `pill status ${kind}`;
    alertBox.textContent = text;
    alertBox.classList.remove('hidden');
    setTimeout(()=>alertBox.classList.add('hidden'), 4000);
  }

  // ================== –†–ï–ù–î–ï–† ==================
  function render(items, checkedIds) {
    // —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: —Å–∞–º—ã–µ –Ω–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É
    items.sort((a,b)=>{
      const ta = +new Date(a.published_at || a.published || a.publishedAt || 0);
      const tb = +new Date(b.published_at || b.published || b.publishedAt || 0);
      return tb - ta;
    });

    const lastSeen = new Set(JSON.parse(localStorage.getItem(LAST_SEEN_KEY) || '[]'));
    const curIds = items.map(it => it.id || vidFromUrl(it.url)).filter(Boolean);
    const newOnes = curIds.filter(id => !lastSeen.has(id));
    if (newOnes.length) {
      playBeep();
      localStorage.setItem(LAST_SEEN_KEY, JSON.stringify(curIds.slice(0, 500)));
    }

    updatedAtEl.textContent = `–æ–±–Ω–æ–≤–ª–µ–Ω–æ: ${new Date().toLocaleString()}`;
    grid.innerHTML = '';

    for (const it of items) {
      const url = it.url || `https://youtu.be/${it.id}`;
      const vid = it.id || vidFromUrl(url);
      const title = it.title || '(–±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è)';
      const ch = it.channel_title || it.channel || '';
      const when = it.published_at || it.published || it.publishedAt || '';
      const ago = when ? timeAgo(when) : '';

      const card = document.createElement('div');
      card.className = 'card';

      const top = document.createElement('div');
      top.className = 'top';
      const chEl = document.createElement('div');
      chEl.className = 'ch';
      chEl.textContent = ch;
      const ageEl = document.createElement('div');
      ageEl.className = 'age';
      ageEl.textContent = ago;
      top.append(chEl, ageEl);

      const tA = document.createElement('a');
      tA.className = 'titleln';
      tA.href = url;
      tA.target = '_blank';
      tA.rel = 'noreferrer noopener';
      tA.textContent = title;

      const controls = document.createElement('div');
      controls.className = 'controls';
      const checkline = document.createElement('label');
      checkline.className = 'checkline';
      const cb = document.createElement('input');
      cb.type = 'checkbox';
      cb.checked = checkedIds.has(vid);
      const lbl = document.createElement('span');
      lbl.textContent = '–í –æ–±—Ä–∞–±–æ—Ç–∫—É';
      checkline.append(cb, lbl);

      const status = document.createElement('div');
      status.className = 'status muted';
      status.textContent = cb.checked ? '–æ—Ç–º–µ—á–µ–Ω–æ' : '';

      cb.addEventListener('change', async ()=>{
        const assignee = assigneeSel.value;
        cb.disabled = true;
        try {
          await apiToggle(vid, cb.checked, url, assignee);
          status.textContent = cb.checked ? '–æ—Ç–º–µ—á–µ–Ω–æ' : '';
          cb.disabled = false;
        } catch (e) {
          cb.checked = !cb.checked; // –æ—Ç–∫–∞—Ç
          cb.disabled = false;
          showAlert('–û—à–∏–±–∫–∞ –æ—Ç–º–µ—Ç–∫–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.', 'err');
        }
      });

      controls.append(checkline, status);
      card.append(top, tA, controls);
      grid.append(card);
    }
  }

  // ================== –ó–ê–ì–†–£–ó–ö–ê ==================
  async function loadAndRender() {
    try {
      const [data, checkedJson] = await Promise.allSettled([
        fetchJson(RESULTS_URL, true),
        apiGetChecked()
      ]);
      if (data.status !== 'fulfilled') throw data.reason;
      const items = Array.isArray(data.value?.items) ? data.value.items :
                    Array.isArray(data.value) ? data.value : [];
      const checkedIds = new Set(
        checkedJson.status === 'fulfilled' ? (checkedJson.value?.checked || []) : []
      );
      render(items, checkedIds);
    } catch (e) {
      showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + (e?.message || e), 'err');
    }
  }

  // –ø–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ –∏ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
  loadAndRender();
  setInterval(loadAndRender, REFRESH_MS);
  </script>
</body>
</html>
